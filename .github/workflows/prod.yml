name: Deploy JAR app to Azure Web App - bp-test-java-app

on:
  push:
    branches: [ release ]

jobs:

  deploy:
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: java-app

      # Always deploy to staging slot first
      - name: Deploy to Staging Slot
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'bp-test-java-app'
          slot-name: 'staging'
          package: '*.jar'
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_9C76509E88C34E8EB1B370CE0EC75F6A }}

      # Health check before swapping
      - name: Smoke test on staging
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://bp-test-java-app-staging.azurewebsites.net/actuator/health)
          if [ "$STATUS" -ne 200 ]; then
            echo "❌ Smoke test failed"
            exit 1
          fi
          echo "✅ Staging slot healthy"

      # Swap only if on main branch
      - name: Swap Staging → Production
        if: github.ref_name == 'release'
        uses: azure/cli@v2
        with:
          inlineScript: |
            echo "Swapping slots..."
            az webapp deployment slot swap \
              --name bp-test-java-app \
              --resource-group YOUR_RESOURCE_GROUP_NAME \
              --slot staging \
              --target-slot production
            echo "Swap complete"
            
